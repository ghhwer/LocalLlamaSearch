<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wireframe Mockup</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <!--Requirements-->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
    <div class="container-fluid">
        <div class="row main">
            <div class="col-md-1 p-0 sidebar">
                <div class="logo-text d-flex align-items-center justify-content-center">
                    <div>
                        <div class="text">TEXT</div>
                    </div>
                </div>
                <div class="side-button search p-3">SEARCH</div>
                <div class="side-button kb p-3 active">KB</div>
                <div class="side-button settings p-3">SETTINGS</div>
            </div>
            <div class="col-md-11 p-0" id="search" hidden>
                <div class="header p-3">
                    <h4>What do you want to search for?</h4>
                    <input type="text" class="form-control" placeholder="Query...">
                </div>
                <div class="results-section p-3">
                    <div class="btn-group mb-3" role="group">
                        <button type="button" class="btn btn-secondary">A</button>
                        <button type="button" class="btn btn-secondary">B</button>
                        <button type="button" class="btn btn-secondary">C</button>
                    </div>
                    <div class="results-box p-3">
                        blablablablablabla
                    </div>
                </div>
            </div>
            <div class="col-md-11 p-0" id="kb">
                <div class="header p-3">
                    <h4>Knowledge Base</h4>
                </div>
                <h4 class="p-3">Add Files</h4>
                <div class="row">
                    <div class="col-md-12">
                        <div class="dropzone">
                            <div class="dropzone-text">Drop new files here</div>
                        </div>
                    </div>
                </div>
                <div id="has-files" hidden>
                    <div class="row pt-2">
                        <div class="col-md-12">
                            <div class="d-flex flex-row mb-3 dropzone-files">
                            </div>
                        </div>
                    </div>
                    <div class="row pt-2 pl-2">
                        <div class="col-md-12">
                            <button class="btn btn-primary" onclick="uploadKB()">Upload</button>
                        </div>
                    </div>
                </div>
                <div id="uploading-files" hidden>
                    <div class="row pt-2 pl-2">
                        <div class="col-md-12 d-flex flex-row">
                            <div id="uploading-files-progress-show">Uploading Files (0/0)</div>
                            <div class="loader ml-2"></div>
                        </div>
                    </div>
                </div>
                <hr>
                <div>
                    <h4 class="p-3">Current Files</h4>
                    <div class="p-3" id="table"></div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    // ======= UTILS ==========
    var showFailureAlert = function(message) {
        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });
        Toast.fire({
            icon: "error",
            title: message,

        });
    }
    var showSuccessAlert = function(message) {
        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });
        Toast.fire({
            icon: "success",
            title: message,
        });
    }
    // ======= GRIDJS FILES ==========
    var Grid = gridjs.Grid;
    var html = gridjs.html;

    var downloadFileWithId = function(id) {
        // download file with id
        console.info('Downloading file with id: ' + id)
    }
    var deleteFileWithId = function(id) {
        // delete file with id
        console.info('Deleting file with id: ' + id)
    }
    
    var formatStatus = function(cell) {
        // if cell == 'Synced' return '<div class="synced">Synced</div>'
        // if cell == 'Syncing' return '<div class="syncing">Syncing</div>'
        // if cell == 'Not Synced' return '<div class="not-synced">New</div>'
        if (cell == 'ready') {
            return html('<div class="d-flex justify-content-left"><div class="pr-2 text-success no-select">Ready</div> <span class="checkmark"><div class="checkmark_stem"></div><div class="checkmark_kick"></div></span> </div>');
        } else if (cell == 'syncing') {
            return html('<div class="d-flex justify-content-left"><div class="pr-2 text-info no-select">Syncing</div><div class="loader"></div> </div>');
        } else if (cell == 'deleting') {
            return html('<div class="d-flex justify-content-left"><div class="pr-2 text-danger no-select">Deleting</div> <div class="loader-red"></div> </div>');
        }
    }

    var formatActions = function(_, row) {
        var canDelete = false;
        var canDownload = false;
        if (row.cells[1].data == 'ready') {
            canDelete = true;
            canDownload = true;
        } else if (row.cells[1].data == 'syncing') {
            canDelete = false;
            canDownload = false;
        } else if (row.cells[1].data == 'deleting') {
            canDelete = false;
            canDownload = false;
        }
        html_str = ""
        if (canDownload) {
            html_str += `<div class="btn btn-info m-1" onclick="downloadFileWithId('${row.cells[0].data}')">Download</div>`;
        } 
        if (canDelete) {
            html_str += `<div class="btn btn-danger m-1" onclick="deleteFileWithId('${row.cells[0].data}')">Delete</div>`;
        }
        if (canDelete == false && canDownload == false) {
            return html('<div class="m-2 text-muted no-select">N/A</div>');
        }
        console.log(html_str);
        return html(`<div class="d-flex justify-content-left">${html_str}</div>`);
    }

    new Grid(
        { 
            columns: [
                'File Name', 
                { 
                    name: 'Status',
                    formatter: formatStatus
                }, 
                {
                    name: 'Actions',
                    formatter: formatActions
                }
            ],
            sort: true,

            data: [
                ['example-1.txt', 'ready', ''],
                ['example-2.pdf', 'syncing', ''],
                ['example-1.txt', 'deleting', ''],
            ]
        },
    ).render(document.getElementById('table'));
    
    // ======= FILES DROPZONE ==========
    var files_in_queue = {};
    var upload_in_progress = false;
    const ACCPETED_FILE_TYPES = ['application/pdf', 'text/plain'];
    // Get the dropzone element
    var dropzone = document.querySelector('.dropzone');

    var delete_file = function(file_id) {
        // Delete file from the queue
        delete files_in_queue[file_id];
        updateFileUI();
    }

    var uploadFile = async function(file) {
        let extension = file.name.split('.').pop();
        let filename_no_extension = file.name.replace(/\.[^/.]+$/, "");
        let normalizedFileName = filename_no_extension.replace(/[^a-zA-Z0-9]/g, '_');
        let formData = new FormData();
        formData.append('file', file, normalizedFileName+'.'+extension);
        url = `http://localhost:8080/api/files/upload`;
        let response = await fetch(url, {
            method: 'POST',
            body: formData
        });
        let data = await response.json();
        if (response.status == 409) {
            showFailureAlert('File with the same name already exists');
            return 1;
        }
        else if (response.status != 200) {
            showFailureAlert('Failed to upload file');
            return 1;
        }
        return 0;
    }

    var uploadFilesToServer = async function(files) {
        // Upload files to the server
        status = 0;
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            console.log('Uploading file: ' + file.name);
            document.getElementById('uploading-files-progress-show').innerHTML = 'Uploading Files (' + (i + 1) + '/' + files.length + ')';
            status += await uploadFile(file);
            
        }
        if (status == 0) {
            showSuccessAlert('Files uploaded successfully');
        }
        document.getElementById('uploading-files').hidden = true;
        upload_in_progress = false;
    }

    var updateFileUI = function() {
        // Remove all files from the UI
        document.querySelector('.dropzone-files').innerHTML = '';
        for (var key in files_in_queue) {
            console.log('Key: ' + key + ' Value: ' + files_in_queue[key].name);
            var file_element = document.createElement('div');
            file_element.classList.add('p-2', 'file');
            file_element.id = key;
            file_element.onclick = function() {
                delete_file(this.id);
            }
            file_element.innerHTML = files_in_queue[key].name;
            document.querySelector('.dropzone-files').appendChild(file_element);
        }

        if (Object.keys(files_in_queue).length == 0) {
            document.getElementById('has-files').hidden = true;
        }
        if (Object.keys(files_in_queue).length > 0) {
            document.getElementById('has-files').hidden = false;
        }
    }

    var uploadKB = function() {
        // Lock the upload button
        upload_in_progress = true;
        // Upload files in the queue
        console.log('Uploading files in the queue');
        const files_in_queue_copy = Object.values(files_in_queue);
        files_in_queue = {};
        updateFileUI();
        document.getElementById('uploading-files').hidden = false;
        document.getElementById('uploading-files-progress-show').innerHTML = 'Uploading Files (0/' + files_in_queue_copy.length + ')';
        console.log(files_in_queue_copy);
        uploadFilesToServer(files_in_queue_copy)
        
    }

    var addFile = function(file) {
        // Add file to the queue
        var random_id = Math.floor(Math.random() * 1000000);
        files_in_queue[random_id] = file;
        updateFileUI();
    }

    // Add event listener for the 'dragover' event
    dropzone.addEventListener('dragover', function(event) {
        // Prevent default behavior (Prevent file from being opened)
        event.preventDefault();
    });

    // Add event listener for the 'drop' event
    dropzone.addEventListener('drop', function(event) {
        // Prevent default behavior (Prevent file from being opened)
        event.preventDefault();
        if (upload_in_progress) {
            showFailureAlert('Please wait for the current upload to finish');
            return;
        }

        // Use DataTransfer.files property to access file(s)
        if (event.dataTransfer.items) {
            // Use DataTransferItemList interface to access the file(s)
            for (var i = 0; i < event.dataTransfer.items.length; i++) {
                // If dropped items aren't files, reject them
                if (event.dataTransfer.items[i].kind === 'file') {
                    // Check file type
                    var file_type = event.dataTransfer.items[i].type;
                    console.log('File[' + i + '].type = ' + file_type);
                    if (ACCPETED_FILE_TYPES.includes(file_type) == false) {
                        showFailureAlert('We only accept PDF and Text files');
                        continue;
                    }

                    var file = event.dataTransfer.items[i].getAsFile();
                    console.log('File[' + i + '].name = ' + file.name);
                    addFile(file);
                }
            }
        } else {
            // Use DataTransfer interface to access the file(s)
            for (var i = 0; i < event.dataTransfer.files.length; i++) {
                console.log('File[' + i + '].name = ' + event.dataTransfer.files[i].name);
            }  
        }
    });

</script>

</html>
